# 模型测速功能说明

## 功能概述
模型测速功能用于测试各个AI模型的响应速度，包括首次响应时间和平均响应速度。测试结果以ms/字为单位显示在模型选择下拉框中。

## 实现架构

### WebSocket架构
1. 连接管理（SpeedTestButtonWebSocket）
   - 专用的WebSocket连接池
   - 统一的连接接口：getConnection(blockIndex, model)
   - 连接标识格式：speed_test_${model}_${timestamp}
   - 自动的连接清理机制（30秒超时）

2. 并发控制（SpeedTestButtonQueue）
   - 固定并发数为4
   - 独立的请求队列管理
   - 指数退避重试机制
   - 完整的错误处理流程

3. 消息处理
   - 统一的消息类型处理
   - 完善的空值检查
   - 标准化的错误提示
   - 实时的状态更新

### 前端实现 (App.vue)
- 使用专用WebSocket进行并行测试
- 利用专用队列管理并发
- 支持实时显示测试结果
- 使用颜色编码直观展示速度等级

```typescript
// 速度等级颜色编码
- 绿色 (<50ms/字): 快速
- 黄色 (50-150ms/字): 中等
- 红色 (>150ms/字): 慢速
```

### 后端实现
#### WebSocket服务器 (websocket.ts)
- 使用专用请求队列管理并发请求
- 最大并发数为4
- 测速模式使用特殊的会话ID格式：`speed_test_${model}_${timestamp}`
- 支持测速请求的优先级处理

#### AI服务 (ai-service.ts)
- 针对测速模式跳过常规会话检查
- 使用统一的流式响应处理
- 支持多种模型API的特殊处理

## 使用方法
1. 点击界面顶部的"测速"按钮
2. 系统会自动对所有可用模型进行并行测试
3. 测试结果会实时更新在模型选择下拉框中
4. 测试完成后可以通过颜色和数值直观比较各模型性能

## 测试流程
1. 前端发起测速请求
2. 后端为每个模型创建带特殊前缀的测试会话
3. 发送统一的测试文本("你好")
4. 记录首次响应时间和总响应时间
5. 计算每个字符的平均响应时间
6. 返回测试结果并更新UI

## 错误处理
- 测试失败会显示错误图标
- 支持自动重试机制（最多3次）
- 指数退避策略（1s, 2s, 4s...，最大10秒）
- 详细的错误日志记录

## 性能优化
- 使用专用请求队列控制并发
- 测速模式特殊处理，避免会话管理开销
- 并行测试提高效率
- 实时反馈保证用户体验

## 注意事项
1. 测试结果可能受网络状况影响
2. 建议在网络稳定时进行测试
3. 测试过程中避免刷新页面
4. 测试完成前不要切换模型
