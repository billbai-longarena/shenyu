# SN43View 组件文档

## 组件架构

SN43View采用了组件拆分和功能复用的策略，将原本庞大的单文件组件拆分为更小、更专注的部分：

### 组件结构

1. **SN43View.vue** (主组件)
   - 负责整体布局和状态管理
   - 协调子组件之间的通信
   - 处理历史记录的保存和恢复

2. **UserInterface.vue** (用户界面组件)
   - 组织和协调子组件
   - 管理共享状态
   - 处理组件间通信
   
   子组件：
   - **ResizableLayout.vue**: 处理可调整大小的两栏布局
   - **ConfigSelector.vue**: 处理配置文件的选择和加载
   - **InputPanel.vue**: 处理用户输入表单
   - **ExecutionPanel.vue**: 处理执行状态和并行模式显示
   - **OutputPanel.vue**: 处理输出结果的显示和复制功能

3. **ConfigPanel.vue** (配置面板组件)
   - 管理用户输入配置
   - 处理提示词配置
   - 提供配置导入导出功能

## 最近更新

### 2024-02-05 默认值标签功能
1. 输入框默认值功能
   - 在inputBx中支持`<def>默认值</def>`标签
   - 标签内容会自动填入对应的inputAx输入框
   - 标签在label显示时会被自动移除
   - 实现了更灵活的输入框默认值设置

2. 组件改进
   - 优化了InputPanel的label显示逻辑
   - 添加了标签解析和处理机制
   - 改进了配置文件的示例和说明
   - 保持了原有功能的完整性

### 2024-02-04 UserInterface组件重构
1. 组件拆分
   - 将UserInterface.vue拆分为5个专注的子组件
   - 优化了组件间的通信机制
   - 改进了状态管理方式
   - 提高了代码的可维护性

2. 架构优化
   - 实现了更清晰的职责划分
   - 简化了主组件的职责
   - 改进了组件间的数据流转
   - 优化了状态管理策略

3. 性能改进
   - 组件粒度更细，减少不必要的重渲染
   - 优化了状态更新逻辑
   - 改进了事件处理机制

## 功能说明

### 默认值标签
在inputBx中可以使用`<def>默认值</def>`标签来设置对应inputAx的默认值：
- 格式：`描述文本<def>默认值</def>`
- 例如：`客户公司<def>某某科技</def>`
  * 在inputAx前的label中只会显示"客户公司"
  * inputAx的输入框会自动填入"某某科技"作为默认值
  * inputBx中保持完整内容"客户公司<def>某某科技</def>"不变
- 使用场景：
  * 为常用输入提供默认值
  * 简化用户输入操作
  * 保持配置文件的可读性

## 按钮功能说明

### 用户界面按钮

1. **载入按钮**
   - 功能：载入选中的JSON配置文件
   - 实现逻辑：
     * 通过fetch请求获取JSON文件内容
     * 使用importConfig方法导入配置
     * 触发配置加载成功提示
   - 禁用条件：
     * 当配置被修改时（isConfigModified为true）
     * 当正在查看历史记录时（isEditing为true）
   - 相关方法：loadJsonConfig

2. **执行/重写按钮**
   - 功能：执行当前输入或重写历史记录
   - 实现逻辑：
     * 检查是否有输入和执行状态
     * 清空现有输出
     * 创建空的输出块
     * 执行流式处理
     * 更新历史记录
   - 按钮文本：
     * 新对话时显示"执行"
     * 编辑历史记录时显示"重写"
     * 无输入时显示"请先载入模板"
   - 禁用条件：
     * 无用户输入时
     * 任何block正在处理中（streaming或pending状态）
     * 已有任务正在执行中
   - 相关方法：executeUserInputs

3. **复制结果按钮**
   - 功能：复制输出结果到剪贴板
   - 实现逻辑：
     * 提取纯文本内容
     * 优先使用Clipboard API
     * 降级使用execCommand
     * 显示复制成功提示
   - 显示条件：只在有输出结果时显示
   - 相关方法：copyOutputResult

### 配置面板按钮

1. **保存并导出按钮**
   - 功能：导出当前配置为JSON文件
   - 实现逻辑：
     * 收集当前所有配置
     * 转换为JSON格式
     * 创建下载链接
     * 触发文件下载
   - 相关方法：exportConfig

2. **导入JSON按钮**
   - 功能：从JSON文件导入配置
   - 实现逻辑：
     * 触发文件选择
     * 读取文件内容
     * 解析JSON数据
     * 导入配置
     * 触发配置修改事件
   - 相关方法：handleFileUpload

3. **插入按钮**
   - 功能：在提示词中插入输入框占位符
   - 实现逻辑：
     * 检查是否有焦点
     * 获取占位符文本
     * 在光标位置插入
     * 触发配置修改事件
   - 禁用条件：当没有选中提示词输入框时
   - 相关方法：insertPlaceholder

4. **删除按钮**
   - 功能：删除输入框或提示词块
   - 实现逻辑：
     * 显示确认对话框
     * 删除相关配置
     * 同步删除关联数据
     * 触发配置修改事件
   - 相关方法：deleteAdminInput, deletePromptBlock

5. **预览提示词按钮**
   - 功能：预览提示词块的效果
   - 实现逻辑：
     * 替换占位符
     * 调用AI接口
     * 显示处理结果
     * 支持Markdown渲染
   - 相关方法：previewPrompt

6. **增加用户输入按钮**
   - 功能：添加新的输入框对
   - 实现逻辑：
     * 生成新的计数器
     * 创建管理员输入框
     * 创建用户输入框
     * 触发配置修改事件
   - 相关方法：addUserInput

7. **增加提示词块按钮**
   - 功能：添加新的提示词块
   - 实现逻辑：
     * 创建空的提示词块
     * 添加到提示词列表
     * 触发配置修改事件
   - 相关方法：addPromptBlock

## 状态管理策略

### 1. 主组件状态
- 使用reactive管理复杂对象状态（userInputs, adminInputs, promptBlocks）
- 使用ref管理简单状态（activeTab, isEditing, inputCounter）
- 集中管理共享状态，通过props向下传递

### 2. 子组件状态
- 保持最小化的本地状态
- 使用props接收父组件状态
- 通过emit向上传递更新

### 3. 状态同步
- 使用watch监听props变化
- 使用v-model:xxx进行双向绑定
- 通过emit及时通知状态变化

## 复用策略

### 1. 逻辑复用
- 将通用逻辑抽取为composables
- 保持composables的单一职责
- 通过参数配置实现灵活性

### 2. 组件复用
- 组件接口统一使用TypeScript类型
- props和emits清晰定义
- 保持组件的独立性和可测试性

### 3. 样式复用
- 通用样式放在layout.css
- 组件特定样式使用scoped
- 使用CSS变量实现主题定制

## 最佳实践

1. **状态管理**
   - 避免props和本地状态命名冲突
   - 使用watch immediate选项确保初始同步
   - 清晰的状态初始化顺序

2. **错误处理**
   - 统一的错误提示
   - 合理的错误恢复机制
   - 完善的错误日志

3. **性能优化**
   - 合理的组件拆分
   - 最小化的状态更新
   - 及时的资源释放

## 注意事项

1. **组件通信**
   - 使用props向下传递数据
   - 使用emit向上传递事件
   - 避免跨级组件通信

2. **状态同步**
   - 注意watch的使用时机
   - 正确处理undefined和空值
   - 保持状态的单一来源

3. **代码维护**
   - 清晰的代码注释
   - 统一的命名规范
   - 模块化的代码组织

## 最近更新

### 2024-02-04 执行按钮状态管理优化
1. 执行状态管理改进
   - 添加了BlockManager执行状态跟踪
   - 优化了执行按钮的禁用逻辑
   - 改进了错误处理和状态恢复机制
   - 提供更清晰的执行状态反馈

2. 并发处理优化
   - 防止在执行过程中重复触发
   - 正确处理并行模式下的按钮状态
   - 优化了状态同步机制

3. 用户体验改进
   - 更直观的执行状态展示
   - 清晰的错误提示
   - 一致的按钮行为

### 2024-01-25
- 优化了 deepseek 模型的温度选项：
  * 代码生成/数学解题 (温度值: 0)
  * 数据抽取/分析 (温度值: 1)
  * 通用对话和翻译 (温度值: 1.3，默认选项)
  * 创意类写作/诗歌创作 (温度值: 1.5)
- 移除了"恢复默认"按钮
- 优化了JSON文件选择状态的保存和恢复
- 改进了按钮禁用状态的控制逻辑
- 完善了按钮功能文档

### 2024-01-20
- 修复了多个prompt结果显示不完整的问题
- 优化了流式处理的状态管理
- 改进了历史记录的处理机制
- 完善了文档和注释

### 主要改进

1. **流式处理完整性优化**
   - 完整的状态标记处理
   - 块内容管理改进
   - 错误处理增强

2. **多块结果处理优化**
   - 状态管理改进
   - 内容保存机制
   - 显示逻辑优化

3. **历史记录处理改进**
   - 存储优化
   - 恢复机制改进
   - 展示优化

## 未来计划

1. **性能优化**
   - 考虑使用虚拟滚动
   - 优化大数据渲染
   - 添加缓存机制

2. **功能增强**
   - 添加更多配置选项
   - 优化用户交互体验
   - 增强错误处理机制

3. **代码质量**
   - 添加单元测试
   - 完善类型定义
   - 优化代码复用
